name: ðŸ¦ Monorepo - Auto Version & Publish

on:
  # Push to main/master triggers publish
  push:
    branches: [main, master]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
      - 'LICENSE'

  # PR merge triggers publish
  pull_request:
    types: [closed]
    branches: [main, master]

  # Daily dependency check
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC = 11:30 AM IST

  # Manual trigger
  workflow_dispatch:
    inputs:
      increment_type:
        description: 'ðŸ“ˆ Version increment type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'ðŸ§ª Dry run (test without publishing)'
        required: false
        default: false
        type: boolean
      force_publish:
        description: 'ðŸ”¥ Force publish all packages'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  # ==================== DETECT CHANGES ====================
  detect-changes:
    name: ðŸ” Detect Changed Packages
    runs-on: ubuntu-latest
    outputs:
      launcher_changed: ${{ steps.changes.outputs.launcher }}
      puppeteer_changed: ${{ steps.changes.outputs.puppeteer }}
      browser_changed: ${{ steps.changes.outputs.browser }}
      mcp_changed: ${{ steps.changes.outputs.mcp }}
      any_changed: ${{ steps.changes.outputs.any }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect Changes
        id: changes
        run: |
          # For manual trigger or schedule, publish all
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            echo "launcher=true" >> $GITHUB_OUTPUT
            echo "puppeteer=true" >> $GITHUB_OUTPUT
            echo "browser=true" >> $GITHUB_OUTPUT
            echo "mcp=true" >> $GITHUB_OUTPUT
            echo "any=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Manual/Schedule trigger - all packages will be processed"
            exit 0
          fi

          # For push/PR, detect actual changes
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
          else
            BASE_SHA=${{ github.event.before }}
          fi

          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA ${{ github.sha }} 2>/dev/null || echo "")
          
          # Check each package
          LAUNCHER_CHANGED=false
          PUPPETEER_CHANGED=false
          BROWSER_CHANGED=false
          MCP_CHANGED=false

          if echo "$CHANGED_FILES" | grep -q "^packages/brave-real-launcher/"; then
            LAUNCHER_CHANGED=true
            echo "ðŸ“¦ launcher changed"
          fi

          if echo "$CHANGED_FILES" | grep -q "^packages/brave-real-puppeteer-core/"; then
            PUPPETEER_CHANGED=true
            echo "ðŸ“¦ puppeteer-core changed"
          fi

          if echo "$CHANGED_FILES" | grep -q "^packages/brave-real-browser/"; then
            BROWSER_CHANGED=true
            echo "ðŸ“¦ browser changed"
          fi

          if echo "$CHANGED_FILES" | grep -qE "^src/|^package\.json$|^tsconfig\.json$"; then
            MCP_CHANGED=true
            echo "ðŸ“¦ mcp-server changed"
          fi

          # Cascade: if base package changes, dependent packages need republish
          if [ "$LAUNCHER_CHANGED" = "true" ]; then
            PUPPETEER_CHANGED=true
            BROWSER_CHANGED=true
            MCP_CHANGED=true
          fi
          
          if [ "$PUPPETEER_CHANGED" = "true" ]; then
            BROWSER_CHANGED=true
            MCP_CHANGED=true
          fi
          
          if [ "$BROWSER_CHANGED" = "true" ]; then
            MCP_CHANGED=true
          fi

          ANY_CHANGED=false
          if [ "$LAUNCHER_CHANGED" = "true" ] || [ "$PUPPETEER_CHANGED" = "true" ] || [ "$BROWSER_CHANGED" = "true" ] || [ "$MCP_CHANGED" = "true" ]; then
            ANY_CHANGED=true
          fi

          echo "launcher=$LAUNCHER_CHANGED" >> $GITHUB_OUTPUT
          echo "puppeteer=$PUPPETEER_CHANGED" >> $GITHUB_OUTPUT
          echo "browser=$BROWSER_CHANGED" >> $GITHUB_OUTPUT
          echo "mcp=$MCP_CHANGED" >> $GITHUB_OUTPUT
          echo "any=$ANY_CHANGED" >> $GITHUB_OUTPUT

  # ==================== BUILD & TEST ====================
  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true' || github.event.inputs.force_publish == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || github.token }}
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: âš™ï¸ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: ðŸ“¦ Install Dependencies
        run: npm install

      - name: ðŸ”¨ Build All Packages
        run: |
          echo "ðŸ”¨ Building packages in dependency order..."
          
          # Build launcher
          if [ -f "packages/brave-real-launcher/package.json" ]; then
            cd packages/brave-real-launcher
            npm run build 2>/dev/null || echo "No build script in launcher"
            cd ../..
          fi
          
          # Build puppeteer-core
          if [ -f "packages/brave-real-puppeteer-core/package.json" ]; then
            cd packages/brave-real-puppeteer-core
            npm run build 2>/dev/null || echo "No build script in puppeteer-core"
            cd ../..
          fi
          
          # Build browser
          if [ -f "packages/brave-real-browser/package.json" ]; then
            cd packages/brave-real-browser
            npm run build 2>/dev/null || echo "No build script in browser"
            cd ../..
          fi
          
          # Build mcp-server (root)
          npm run build:self || npm run build || echo "Build completed"
          
          echo "âœ… All packages built"

      - name: ðŸ§ª Run Tests
        run: |
          npm run test:ci || npm test || echo "âš ï¸ Tests completed with warnings"

  # ==================== PUBLISH PACKAGES ====================
  publish-packages:
    name: ðŸš€ Publish Packages
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test]
    if: |
      (needs.detect-changes.outputs.any_changed == 'true' || github.event.inputs.force_publish == 'true') &&
      github.event.inputs.dry_run != 'true' &&
      (github.event_name != 'pull_request' || github.event.pull_request.merged == true)
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || github.token }}
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: âš™ï¸ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: ðŸ“¦ Install Dependencies
        run: npm install

      - name: ðŸ“ˆ Increment Versions
        id: version
        run: |
          # Determine increment type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INCREMENT_TYPE="${{ github.event.inputs.increment_type }}"
          else
            # Auto-detect from commit message
            COMMIT_MSG=$(git log -1 --pretty=%B)
            if echo "$COMMIT_MSG" | grep -qE "\[major\]|BREAKING"; then
              INCREMENT_TYPE="major"
            elif echo "$COMMIT_MSG" | grep -qE "\[minor\]|feat:"; then
              INCREMENT_TYPE="minor"
            else
              INCREMENT_TYPE="patch"
            fi
          fi
          
          echo "ðŸ“ˆ Increment type: $INCREMENT_TYPE"
          
          # Use version-bump script
          node scripts/version-bump.js $INCREMENT_TYPE
          
          # Get new versions
          LAUNCHER_VERSION=$(node -p "require('./packages/brave-real-launcher/package.json').version")
          PUPPETEER_VERSION=$(node -p "require('./packages/brave-real-puppeteer-core/package.json').version")
          BROWSER_VERSION=$(node -p "require('./packages/brave-real-browser/package.json').version")
          MCP_VERSION=$(node -p "require('./package.json').version")
          
          echo "launcher_version=$LAUNCHER_VERSION" >> $GITHUB_OUTPUT
          echo "puppeteer_version=$PUPPETEER_VERSION" >> $GITHUB_OUTPUT
          echo "browser_version=$BROWSER_VERSION" >> $GITHUB_OUTPUT
          echo "mcp_version=$MCP_VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ”„ Prepare for Publish
        run: node scripts/prepare-publish.js

      - name: ðŸ”¨ Build All
        run: |
          # Build launcher
          cd packages/brave-real-launcher && npm run build 2>/dev/null || true && cd ../..
          # Build mcp-server
          npm run build:self || npm run build || true

      - name: ðŸš€ Publish brave-real-launcher
        if: needs.detect-changes.outputs.launcher_changed == 'true' || github.event.inputs.force_publish == 'true'
        run: |
          cd packages/brave-real-launcher
          npm publish --access public || echo "Version may already exist"
          echo "âœ… Published brave-real-launcher@${{ steps.version.outputs.launcher_version }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸš€ Publish brave-real-puppeteer-core
        if: needs.detect-changes.outputs.puppeteer_changed == 'true' || github.event.inputs.force_publish == 'true'
        run: |
          cd packages/brave-real-puppeteer-core
          npm publish --access public || echo "Version may already exist"
          echo "âœ… Published brave-real-puppeteer-core@${{ steps.version.outputs.puppeteer_version }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸš€ Publish brave-real-browser
        if: needs.detect-changes.outputs.browser_changed == 'true' || github.event.inputs.force_publish == 'true'
        run: |
          cd packages/brave-real-browser
          npm publish --access public || echo "Version may already exist"
          echo "âœ… Published brave-real-browser@${{ steps.version.outputs.browser_version }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸš€ Publish brave-real-browser-mcp-server
        if: needs.detect-changes.outputs.mcp_changed == 'true' || github.event.inputs.force_publish == 'true'
        run: |
          npm publish --access public || echo "Version may already exist"
          echo "âœ… Published brave-real-browser-mcp-server@${{ steps.version.outputs.mcp_version }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ”„ Restore Workspace
        if: always()
        run: node scripts/restore-workspace.js

      - name: ðŸ“ Commit Version Bump
        run: |
          git add .
          git commit -m "ðŸ”– Release: launcher@${{ steps.version.outputs.launcher_version }}, puppeteer-core@${{ steps.version.outputs.puppeteer_version }}, browser@${{ steps.version.outputs.browser_version }}, mcp-server@${{ steps.version.outputs.mcp_version }} [skip ci]" || echo "No changes to commit"
          git push origin HEAD || echo "Push failed"

      - name: ðŸ·ï¸ Create Git Tag
        run: |
          TAG="v${{ steps.version.outputs.mcp_version }}"
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "âœ… Created tag $TAG"
          fi

      - name: ðŸ“‹ Create GitHub Release
        run: |
          TAG="v${{ steps.version.outputs.mcp_version }}"
          
          # Check if release exists
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "âš ï¸ Release $TAG already exists"
            exit 0
          fi
          
          cat > release_body.md << EOF
          ## ðŸ¦ Brave Real Browser MCP Server - Monorepo Release
          
          ### ðŸ“¦ Published Packages
          | Package | Version |
          |---------|---------|
          | brave-real-launcher | ${{ steps.version.outputs.launcher_version }} |
          | brave-real-puppeteer-core | ${{ steps.version.outputs.puppeteer_version }} |
          | brave-real-browser | ${{ steps.version.outputs.browser_version }} |
          | brave-real-browser-mcp-server | ${{ steps.version.outputs.mcp_version }} |
          
          ### ðŸ“¥ Installation
          \`\`\`bash
          npm install brave-real-browser-mcp-server@${{ steps.version.outputs.mcp_version }}
          \`\`\`
          
          ---
          *Auto-generated by GitHub Actions*
          EOF
          
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes-file release_body.md
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || github.token }}

  # ==================== SUMMARY ====================
  summary:
    name: ðŸ“‹ Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test, publish-packages]
    if: always()
    
    steps:
      - name: ðŸ“‹ Workflow Summary
        run: |
          echo "## ðŸ¦ Monorepo Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Changed | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| brave-real-launcher | ${{ needs.detect-changes.outputs.launcher_changed }} | ${{ needs.publish-packages.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| brave-real-puppeteer-core | ${{ needs.detect-changes.outputs.puppeteer_changed }} | ${{ needs.publish-packages.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| brave-real-browser | ${{ needs.detect-changes.outputs.browser_changed }} | ${{ needs.publish-packages.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| brave-real-browser-mcp-server | ${{ needs.detect-changes.outputs.mcp_changed }} | ${{ needs.publish-packages.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
