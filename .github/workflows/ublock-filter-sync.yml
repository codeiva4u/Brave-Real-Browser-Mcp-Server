name: ðŸ›¡ï¸ uBlock Origin Filter Auto-Sync

on:
  schedule:
    # Check for updates every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean

env:
  FILTERS_FILE: packages/brave-real-blocker/assets/ublock-custom-filters.txt
  CACHE_DIR: packages/brave-real-blocker/cache

jobs:
  sync-ublock-filters:
    name: ðŸ”„ Sync uBlock Origin Filters
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || github.token }}
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âš™ï¸ Configure Git
        run: |
          git config --global user.name "brave-real-bot"
          git config --global user.email "bot@bravereal.com"

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd packages/brave-real-blocker
          npm install

      - name: ðŸ”„ Fetch Latest uBlock Origin Filters
        id: fetch_filters
        run: |
          mkdir -p ${{ env.CACHE_DIR }}
          
          echo "ðŸ“¥ Fetching uBlock Origin filter lists..."
          
          # uBlock Origin official filter URLs
          declare -A FILTER_URLS=(
            ["ublock_filters"]="https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/filters.txt"
            ["ublock_badware"]="https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/badware.txt"
            ["ublock_privacy"]="https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/privacy.txt"
            ["ublock_resource_abuse"]="https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/resource-abuse.txt"
            ["ublock_unbreak"]="https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/unbreak.txt"
            ["ublock_quick_fixes"]="https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/quick-fixes.txt"
            ["ublock_annoyances"]="https://raw.githubusercontent.com/uBlockOrigin/uAssets/master/filters/annoyances.txt"
            ["easylist"]="https://easylist.to/easylist/easylist.txt"
            ["easyprivacy"]="https://easylist.to/easylist/easyprivacy.txt"
          )
          
          # Fetch each filter list
          for name in "${!FILTER_URLS[@]}"; do
            url="${FILTER_URLS[$name]}"
            echo "  Fetching $name..."
            curl -sL "$url" -o "${{ env.CACHE_DIR }}/${name}.txt" || echo "  âš ï¸ Failed to fetch $name"
          done
          
          echo "âœ… Filter lists fetched"

      - name: ðŸ” Extract & Merge Scriptlet Rules
        id: merge_filters
        run: |
          echo "ðŸ”§ Extracting scriptlet and popup blocking rules..."
          
          # Create merged filter file
          MERGED_FILE="${{ env.CACHE_DIR }}/merged-ublock-rules.txt"
          
          cat > "$MERGED_FILE" << 'HEADER'
          ! Title: Brave Real Browser - Auto-Synced uBlock Filters
          ! Description: Auto-patched from uBlock Origin official filters
          ! Homepage: https://github.com/codeiva4u/Brave-Real-Browser-Mcp-Server
          ! Last synced: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          ! Auto-generated by GitHub Actions - DO NOT EDIT MANUALLY
          
          ! ==========================================
          ! Popup/Redirect Blocking Rules (from uBlock Origin)
          ! ==========================================
          HEADER
          
          # Extract popup blocking rules
          echo "" >> "$MERGED_FILE"
          echo "! --- Popup Rules ---" >> "$MERGED_FILE"
          grep -h '\$popup' ${{ env.CACHE_DIR }}/*.txt 2>/dev/null | head -500 >> "$MERGED_FILE" || true
          
          # Extract redirect blocking rules  
          echo "" >> "$MERGED_FILE"
          echo "! --- Redirect Rules ---" >> "$MERGED_FILE"
          grep -h 'redirect=' ${{ env.CACHE_DIR }}/*.txt 2>/dev/null | head -200 >> "$MERGED_FILE" || true
          
          # Extract scriptlet injections (js rules)
          echo "" >> "$MERGED_FILE"
          echo "! --- Scriptlet Injections ---" >> "$MERGED_FILE"
          grep -h '##+js(' ${{ env.CACHE_DIR }}/*.txt 2>/dev/null | head -1000 >> "$MERGED_FILE" || true
          
          # Extract nowoif (no window.open if) rules
          echo "" >> "$MERGED_FILE"
          echo "! --- Window.open Blocking ---" >> "$MERGED_FILE"
          grep -h 'nowoif' ${{ env.CACHE_DIR }}/*.txt 2>/dev/null | head -500 >> "$MERGED_FILE" || true
          
          # Extract abort-on-property-write rules
          echo "" >> "$MERGED_FILE"
          echo "! --- Abort on Property Write ---" >> "$MERGED_FILE"
          grep -h 'aopw' ${{ env.CACHE_DIR }}/*.txt 2>/dev/null | head -300 >> "$MERGED_FILE" || true
          
          # Extract abort-on-property-read rules
          echo "" >> "$MERGED_FILE"
          echo "! --- Abort on Property Read ---" >> "$MERGED_FILE"
          grep -h 'aopr' ${{ env.CACHE_DIR }}/*.txt 2>/dev/null | head -300 >> "$MERGED_FILE" || true
          
          # Extract set-constant rules
          echo "" >> "$MERGED_FILE"
          echo "! --- Set Constant Rules ---" >> "$MERGED_FILE"
          grep -h 'set-constant' ${{ env.CACHE_DIR }}/*.txt 2>/dev/null | head -500 >> "$MERGED_FILE" || true
          
          # Extract remove-attr rules
          echo "" >> "$MERGED_FILE"
          echo "! --- Remove Attribute Rules ---" >> "$MERGED_FILE"
          grep -h 'remove-attr' ${{ env.CACHE_DIR }}/*.txt 2>/dev/null | head -300 >> "$MERGED_FILE" || true
          
          # Count rules
          RULE_COUNT=$(wc -l < "$MERGED_FILE")
          echo "ðŸ“Š Total rules extracted: $RULE_COUNT"
          echo "rule_count=$RULE_COUNT" >> $GITHUB_OUTPUT

      - name: ðŸ“ Update Custom Filters File
        id: update_filters
        run: |
          MERGED_FILE="${{ env.CACHE_DIR }}/merged-ublock-rules.txt"
          CUSTOM_FILE="${{ env.FILTERS_FILE }}"
          
          # Read existing custom rules (user-defined section)
          if [ -f "$CUSTOM_FILE" ]; then
            # Extract user-defined rules (everything before "! === AUTO-SYNCED RULES ===")
            USER_RULES=$(sed -n '1,/! === AUTO-SYNCED RULES ===/p' "$CUSTOM_FILE" 2>/dev/null | head -n -1 || cat "$CUSTOM_FILE")
          else
            USER_RULES="! Title: Brave Real Browser - Custom Filters
          ! Description: User-defined custom filters + Auto-synced uBlock rules
          ! Homepage: https://github.com/codeiva4u/Brave-Real-Browser-Mcp-Server
          ! Version: 1.0.0
          
          ! ==========================================
          ! USER-DEFINED CUSTOM RULES (Edit below)
          ! ==========================================
          
          ! Add your custom rules here...
          "
          fi
          
          # Create new custom filters file
          cat > "$CUSTOM_FILE" << EOF
          $USER_RULES
          
          ! === AUTO-SYNCED RULES === (DO NOT EDIT BELOW THIS LINE)
          ! Last synced: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          ! Source: uBlock Origin official filters
          
          EOF
          
          # Append merged uBlock rules
          cat "$MERGED_FILE" >> "$CUSTOM_FILE"
          
          # Check if file changed
          if git diff --quiet "$CUSTOM_FILE" 2>/dev/null; then
            echo "âœ… No changes detected in filters"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ Filters updated!"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Generate Filter Stats
        run: |
          echo "ðŸ“Š Filter Statistics:"
          echo "===================="
          wc -l ${{ env.FILTERS_FILE }}
          echo ""
          echo "Rule Types:"
          echo "  Popup rules: $(grep -c '\$popup' ${{ env.FILTERS_FILE }} || echo 0)"
          echo "  Scriptlet rules: $(grep -c '##+js(' ${{ env.FILTERS_FILE }} || echo 0)"
          echo "  Redirect rules: $(grep -c 'redirect=' ${{ env.FILTERS_FILE }} || echo 0)"

      - name: ðŸ“¤ Commit & Push Changes
        if: steps.update_filters.outputs.changed == 'true' || github.event.inputs.force_update == 'true'
        run: |
          git add ${{ env.FILTERS_FILE }}
          git add ${{ env.CACHE_DIR }}/*.txt || true
          
          # Create commit with stats
          RULE_COUNT=$(wc -l < ${{ env.FILTERS_FILE }})
          
          git commit -m "chore(blocker): ðŸ›¡ï¸ Auto-sync uBlock Origin filters

          ðŸ“Š Stats:
          - Total rules: $RULE_COUNT
          - Last synced: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - Source: uBlock Origin official filters
          
          [skip ci]" || echo "Nothing to commit"
          
          git push

      - name: ðŸ”„ Rebuild Blocker Package
        if: steps.update_filters.outputs.changed == 'true'
        run: |
          cd packages/brave-real-blocker
          npm run build
          echo "âœ… Blocker package rebuilt"

      - name: ðŸš€ Trigger Version Bump
        if: steps.update_filters.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'monorepo-publish.yml',
                ref: 'main',
                inputs: {
                  force_publish: 'true',
                  increment_type: 'patch'
                }
              });
              console.log("ðŸš€ Triggered version bump for filter update");
            } catch (error) {
              console.log("âš ï¸ Could not trigger publish workflow:", error.message);
            }

      - name: ðŸ“‹ Summary
        run: |
          echo "## ðŸ›¡ï¸ uBlock Filter Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Rules | $(wc -l < ${{ env.FILTERS_FILE }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Popup Rules | $(grep -c '\$popup' ${{ env.FILTERS_FILE }} || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Scriptlet Rules | $(grep -c '##+js(' ${{ env.FILTERS_FILE }} || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Last Synced | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Filter sync completed!" >> $GITHUB_STEP_SUMMARY
